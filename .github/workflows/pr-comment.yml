name: Auto Comment, Label & Size PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-comment-label-size:
    runs-on: ubuntu-latest

    steps:
      - name: Auto Comment on New PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prTitle = pr.title;
            const prBody = pr.body;
            const author = pr.user.login;
            const branchName = pr.head.ref;
            const baseBranch = pr.base.ref;

            const truncatedBody = prBody
              ? (prBody.length > 300 ? prBody.substring(0, 300) + '...' : prBody)
              : '*No description provided*';

            const welcomeMessage = [
              `## ðŸš€ Welcome to Placement Preparation Contribution!`,
              ``,
              `Hi @${author}, thanks for your pull request! ðŸ™Œ`,
              ``,
              `### ðŸ“‹ PR Details`,
              `- **PR #${prNumber}**: ${prTitle}`,
              `- **Branch**: \`${branchName}\` â†’ \`${baseBranch}\``,
              `- **Status**: ðŸ†• New Pull Request`,
              ``,
              `### ðŸ” PR Description`,
              `\`\`\`\n${truncatedBody}\n\`\`\``,
              ``,
              `### âœ… Checklist for Review`,
              `- [ ] Code follows project style guidelines`,
              `- [ ] Self-review completed`,
              `- [ ] Documentation updated (if applicable)`,
              `- [ ] Tests added/updated (if applicable)`,
              `- [ ] No breaking changes introduced`,
              `- [ ] All CI checks passing`,
              ``,
              `### ðŸš€ Next Steps`,
              `1. Maintainers will review this PR within 24â€“48 hours.`,
              `2. Automated CI/CD checks will run to ensure code quality.`,
              `3. Respond to review comments if needed.`,
              `4. Once approved, the PR will be merged.`,
              ``,
              `### ðŸ“š Helpful Resources`,
              `- ðŸ“– [Contributing Guidelines](https://github.com/Shubham-cyber-prog/Placement-Prep/blob/main/README.md)`,
              `- ðŸ”§ [PR Template](https://github.com/Shubham-cyber-prog/Placement-Prep/blob/main/.github/ISSUE_TEMPLATE/PULL_REQUEST_TEMPLATE.md)`,
              `- ðŸ’¬ [Join our Discord](https://discord.gg/BtqrauPm) for discussions`,
              ``,
              `### ðŸ·ï¸ Auto-Labeling`,
              `This PR will be automatically labeled based on its content and files changed.`,
              ``,
              `---`,
              `*Automated message â€” for urgent assistance, join [Discord](https://discord.gg/BtqrauPm).*`
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: welcomeMessage
            });

      - name: Auto Label PRs
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prTitle = pr.title.toLowerCase();
            const prBody = (pr.body || '').toLowerCase();

            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const fileNames = files.data.map(f => f.filename.toLowerCase());

            const labels = ['new-pr'];

            const hasFrontendFiles = fileNames.some(file =>
              file.includes('.tsx') || file.includes('.ts') || file.includes('.jsx') || 
              file.includes('.js') || file.includes('.css') || file.includes('.scss') ||
              file.includes('components/') || file.includes('src/')
            );

            const hasBackendFiles = fileNames.some(file =>
              file.includes('.py') || file.includes('.java') || file.includes('.php') ||
              file.includes('server/') || file.includes('api/') || file.includes('routes/')
            );

            const hasDocs = fileNames.some(file =>
              file.includes('.md') || file.includes('readme') || file.includes('docs/')
            );

            if (prTitle.includes('bug') || prTitle.includes('fix') ||
                prBody.includes('bug') || prBody.includes('fix')) {
              labels.push('bug-fix');
            }

            if (prTitle.includes('feature') || prTitle.includes('enhancement') ||
                prBody.includes('feature') || prBody.includes('enhancement')) {
              labels.push('enhancement');
            }

            if (prTitle.includes('refactor') || prBody.includes('refactor')) {
              labels.push('refactor');
            }

            if (hasFrontendFiles) labels.push('frontend');
            if (hasBackendFiles) labels.push('backend');
            if (hasDocs) labels.push('documentation');

            if (prTitle.includes('gssoc') || prTitle.includes('gsoc') ||
                prBody.includes('gssoc') || prBody.includes('gsoc')) {
              labels.push('gssoc-2025');
            }

            await github.rest.issues.addLabels({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels
            });

      - name: Label PR by Size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;

            let sizeLabel = '';
            if (totalChanges <= 10) sizeLabel = 'size/XS';
            else if (totalChanges <= 30) sizeLabel = 'size/S';
            else if (totalChanges <= 100) sizeLabel = 'size/M';
            else if (totalChanges <= 500) sizeLabel = 'size/L';
            else sizeLabel = 'size/XL';

            await github.rest.issues.addLabels({
              issue_number: pr.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [sizeLabel]
            });
